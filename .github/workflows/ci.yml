name: WordPress CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # ----------------------------
  # Continuous Integration (CI)
  # ----------------------------
  build-and-test:
  
    name: Build & Test WordPress
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping --silent"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mysqli, gd
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Configure wp-config.php
        run: |
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/root/" wp-config.php
          sed -i "s/password_here/root/" wp-config.php
          sed -i "s/localhost/127.0.0.1/" wp-config.php

      - name: Wait for MySQL
        run: |
          for i in {30..0}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -proot >/dev/null 2>&1; then
              break
            fi
            echo "Waiting for MySQL..."
            sleep 1
          done

      - name: Run PHPUnit Tests
        run: php ./vendor/bin/phpunit --bootstrap wp-load.php tests

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests
          
      - name: Run API Tests (Postman/Newman)
        run: |
          if [ -d tests/Api/api-tests ]; then
            python -m pytest -q tests/Api/api-tests/
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: tests/UI/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('tests/UI/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Run UI Tests (Cypress)
        if: ${{ always() }}
        run: |
          if [ -f tests/UI/cypress.config.js ]; then
            cd tests/UI
            npm ci
            npx cypress install
            chmod +x node_modules/.bin/cypress
            npx cypress run --headless
          else
            echo "No Cypress config found, skipping UI tests."
          fi

